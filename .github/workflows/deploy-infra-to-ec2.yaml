name: Deploy Infra to EC2 (Docker Compose)

on:
  workflow_call:
    inputs:
      image:
        type: string
        required: true
      service-name:
        type: string
        required: true
      environment:
        type: string
        required: true
    secrets:
      AWS_EC2_HOST:
        required: true
      AWS_EC2_USER:
        required: false
      AWS_EC2_KEY:
        required: false
        description: Raw SSH private key content (alternative to AWS_EC2_KEY_B64)
      AWS_EC2_KEY_B64:
        required: false
        description: Base64-encoded SSH private key (alternative to AWS_EC2_KEY)

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh

          # Handle SSH key from secret (supports both raw PEM and base64-encoded)
          if [ -n "${{ secrets.AWS_EC2_KEY }}" ]; then
            echo "Using raw SSH key from AWS_EC2_KEY secret..."
            echo "${{ secrets.AWS_EC2_KEY }}" > ~/.ssh/id_rsa
          elif [ -n "${{ secrets.AWS_EC2_KEY_B64 }}" ]; then
            echo "Decoding SSH key from base64 (AWS_EC2_KEY_B64)..."
            if ! echo "${{ secrets.AWS_EC2_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa 2>/dev/null; then
              echo "ERROR: Failed to decode base64 SSH key"
              exit 1
            fi
          else
            echo "ERROR: Neither AWS_EC2_KEY nor AWS_EC2_KEY_B64 secret is set"
            echo "Please set one of these GitHub secrets:"
            echo "- AWS_EC2_KEY: Raw SSH private key content"
            echo "- AWS_EC2_KEY_B64: Base64-encoded SSH private key"
            exit 1
          fi

          chmod 600 ~/.ssh/id_rsa

          # Verify the key is valid
          if ! ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
            echo "WARNING: Key may be in PEM format, attempting conversion..."
            if grep -q "BEGIN RSA PRIVATE KEY" ~/.ssh/id_rsa; then
              echo "Converting PEM format key to OpenSSH format..."
              # Remove passphrase and convert format
              ssh-keygen -p -f ~/.ssh/id_rsa -m pem -P "" -N "" || true
            fi
          fi

          # Final verification
          echo "SSH key validation:"
          if ssh-keygen -l -f ~/.ssh/id_rsa >/dev/null 2>&1; then
            echo "✓ SSH key is valid"
            ssh-keygen -l -f ~/.ssh/id_rsa
          else
            echo "✗ SSH key validation failed"
            head -2 ~/.ssh/id_rsa
            exit 1
          fi

          ssh-keyscan -H "${{ secrets.AWS_EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Test connectivity
        run: |
          echo "Testing SSH port connectivity..."
          nc -zv "${{ secrets.AWS_EC2_HOST }}" 22 || (echo "SSH port unreachable" && exit 1)

          echo "Testing SSH key authentication..."
          HOST="${{ secrets.AWS_EC2_HOST }}"
          USERS="${{ secrets.AWS_EC2_USER || 'ec2-user ubuntu centos admin' }}"

          SSH_SUCCESS=false
          for user in $USERS; do
            echo "Attempting SSH connection as user: $user"
            if ssh -v -o StrictHostKeyChecking=no -o ConnectTimeout=10 -i ~/.ssh/id_rsa "$user@$HOST" "echo 'SSH connection successful as $user'" 2>&1; then
              echo "SUCCESS: SSH works with user '$user'"
              echo "EC2_USER=$user" >> $GITHUB_ENV
              SSH_SUCCESS=true
              break
            else
              echo "FAILED: SSH authentication failed for user '$user'"
            fi
          done

          if [ "$SSH_SUCCESS" != true ]; then
            echo "ERROR: SSH authentication failed for all users. Please check:"
            echo "1. SSH key is correctly set in AWS_EC2_KEY or AWS_EC2_KEY_B64 secret"
            echo "2. Public key is installed on EC2 instance in ~/.ssh/authorized_keys"
            echo "3. Security group allows SSH (port 22) from GitHub Actions IPs"
            echo "4. Correct username is being used"
            echo "SSH_SUCCESS value: $SSH_SUCCESS"
            exit 1
          fi

      - name: Deploy Infra with Docker Compose
        run: |
          EC2_USER="${EC2_USER:-${{ secrets.AWS_EC2_USER || 'ec2-user' }}}"
          HOST="${{ secrets.AWS_EC2_HOST }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          IMAGE="${{ inputs.image }}"
          COMPOSE_FILE="/home/$EC2_USER/docker-compose.infra.yml"
          COMMON_ENV="/home/$EC2_USER/.env"

          echo "Using EC2 user: $EC2_USER"

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa "$EC2_USER@$HOST" << EOF
            set -e

            echo "=== STEP 1: Update Compose image ==="
            sudo sed -i "s|image:.*${SERVICE_NAME}.*|image: $IMAGE|g" "$COMPOSE_FILE"

            echo "Updated Compose service:"
            grep -A 3 "$SERVICE_NAME:" "$COMPOSE_FILE"

            echo "=== STEP 2: Stop service via Docker Compose ==="
            docker-compose -f "$COMPOSE_FILE" stop "$SERVICE_NAME" || true

            echo "=== STEP 3: Remove service via Docker Compose ==="
            docker-compose -f "$COMPOSE_FILE" rm -f "$SERVICE_NAME" || true

            echo "=== STEP 4: HARD REMOVE container if exists ==="
            # matches ONLY exact container name
            if docker ps -a --format '{{.Names}}' | grep -q "^$SERVICE_NAME$"; then
              echo "Force removing leftover container..."
              docker stop "$SERVICE_NAME" || true
              docker rm -f "$SERVICE_NAME" || true
            else
              echo "No leftover container found."
            fi

            echo "=== STEP 5: Start updated service ==="
            docker-compose -f "$COMPOSE_FILE" --env-file "$COMMON_ENV" up -d "$SERVICE_NAME"

            echo "=== STEP 6: Verify container ==="
            docker-compose -f "$COMPOSE_FILE" ps "$SERVICE_NAME"

            echo "=== SUCCESS: Infra service deployed via Docker Compose ==="
          EOF

      - name: Done
        run: echo "Infra deployment completed successfully."
