name: Deploy to EC2

on:
  workflow_call:
    inputs:
      docker-tag:
        required: true
        type: string
      service-name:
        required: true
        type: string
      working-directory:
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_ECR_REPOSITORY:
        required: true
      AWS_EC2_HOST:
        required: true
      AWS_EC2_USER:
        required: true
      AWS_EC2_KEY_B64:
        required: true
      AWS_ACCOUNT_ID:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Prepare SSH key and known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_KEY_B64 }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Test SSH Connection (verbose)
        run: ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -vvv ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} "echo Connected"
        continue-on-error: false

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/id_rsa -o IdentitiesOnly=yes ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} bash -s <<REMOTE
            set -e

            echo "ðŸ“ Switching to working directory"
            cd /home/ec2-user

            ls


            echo "ðŸ” Logging into ECR on EC2"
            aws ecr get-login-password --region "${{ secrets.AWS_REGION }}" |
              docker login --username AWS --password-stdin "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"

            echo "â¬‡ï¸ Pulling Docker image"
            docker pull "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.AWS_ECR_REPOSITORY }}:${{ inputs.docker-tag }}"

            echo "âœï¸ Updating override file with new image"
            sed -i "s|^\(\s*image:\).*|\1 ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.AWS_ECR_REPOSITORY }}:${{ inputs.docker-tag }}|" docker-compose.override.yml

            echo "â™»ï¸ Restarting service with Docker Compose"
            docker compose -f docker-compose.yml -f docker-compose.override.yml stop "${{ inputs.service-name }}" || true
            docker compose -f docker-compose.yml -f docker-compose.override.yml rm -f "${{ inputs.service-name }}" || true
            docker compose -f docker-compose.yml -f docker-compose.override.yml up -d "${{ inputs.service-name }}"
          REMOTE


