name: Deploy to EC2 (Docker Run)

on:
  workflow_call:
    inputs:
      docker-tag:
        type: string
        required: true
      service-name:
        type: string
        required: true
      working-directory:
        type: string
        required: true
      environment:
        type: string
        required: true
      host-port:
        type: string
        required: true
      container-port:
        type: string
        required: true
    secrets:
      AWS_REGION:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AWS_EC2_HOST:
        required: true
      AWS_EC2_USER:
        required: false
      AWS_EC2_KEY_B64:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      # -----------------------------------------------------
      # Install Private EC2 SSH Key
      # -----------------------------------------------------
      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.AWS_EC2_HOST }}" >> ~/.ssh/known_hosts

      # -----------------------------------------------------
      # Test SSH Connectivity
      # -----------------------------------------------------
      - name: Test connectivity
        run: |
          nc -zv "${{ secrets.AWS_EC2_HOST }}" 22 || (echo "SSH port unreachable" && exit 1)

      # -----------------------------------------------------
      # Deploy Service
      # -----------------------------------------------------
      - name: Deploy on EC2
        env:
          IMAGE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ inputs.service-name }}:${{ inputs.docker-tag }}
        run: |
          EC2_USER="${{ secrets.AWS_EC2_USER || 'ec2-user' }}"
          HOST="${{ secrets.AWS_EC2_HOST }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          CONTAINER_NAME="${SERVICE_NAME}-latest"
          PORT_MAPPING="${{ inputs.host-port }}:${{ inputs.container-port }}"
          COMMON_ENV_FILE="/home/$EC2_USER/.env.common"
          SERVICE_ENV_FILE="/home/$EC2_USER/.env.${SERVICE_NAME}"
          MERGED_ENV_FILE="/home/$EC2_USER/.env.merged.${SERVICE_NAME}"

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa "$EC2_USER@$HOST" << EOF
            set -e

            echo "=== 1) Validate env files ==="
            for f in "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE"; do
              if [ ! -f "\$f" ]; then
                echo "ERROR: Missing: \$f"
                exit 1
              fi
            done

            echo "=== 2) Show env files ==="
            echo "--- Common env ---"
            cat "$COMMON_ENV_FILE"
            echo "--- Service env ---"
            cat "$SERVICE_ENV_FILE"

            echo "=== 3) Merge & substitute env correctly ==="
            export \$(grep -v '^#' "$COMMON_ENV_FILE" | xargs)
            export \$(grep -v '^#' "$SERVICE_ENV_FILE" | xargs)

            # Replace only placeholders in service env file
            envsubst < "$SERVICE_ENV_FILE" > "$MERGED_ENV_FILE"

            echo "--- Merged env ---"
            cat "$MERGED_ENV_FILE"

            echo "=== 4) Authenticate to ECR ==="
            aws ecr get-login-password --region "${{ secrets.AWS_REGION }}" \
              | docker login --username AWS --password-stdin \
              "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"

            echo "=== 5) Stop old container ==="
            docker stop "$CONTAINER_NAME" || true
            docker rm "$CONTAINER_NAME" || true

            echo "=== 6) Pull latest image ==="
            docker pull "$IMAGE"

            echo "=== 7) Run new container ==="
            docker run -d \
              --name "$CONTAINER_NAME" \
              --env-file "$MERGED_ENV_FILE" \
              -p $PORT_MAPPING \
              --restart always \
              "$IMAGE"

            echo "=== 8) Check container ==="
            docker ps | grep "$CONTAINER_NAME"
          EOF

      - name: Finished
        run: echo "Deployment completed successfully."
