name: Deploy to EC2 (Docker Run)

on:
  workflow_call:
    inputs:
      docker-tag:
        type: string
        required: true
      service-name:
        type: string
        required: true
      working-directory:
        type: string
        required: true
      environment:
        type: string
        required: true
      host-port:
        type: string
        required: true
      container-port:
        type: string
        required: true
    secrets:
      AWS_REGION:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AWS_EC2_HOST:
        required: true
      AWS_EC2_USER:
        required: false
      AWS_EC2_KEY_B64:
        required: true
      APP_ENV_CONTENT:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.AWS_EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Test connectivity
        run: |
          nc -zv "${{ secrets.AWS_EC2_HOST }}" 22 || (echo "SSH port unreachable" && exit 1)

      - name: Deploy on EC2
        env:
          IMAGE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ inputs['service-name'] }}:${{ inputs['docker-tag'] }}
        run: |
          EC2_USER="${{ secrets.AWS_EC2_USER || 'ec2-user' }}"
          HOST="${{ secrets.AWS_EC2_HOST }}"
          SERVICE_NAME="${{ inputs.service-name }}"
          CONTAINER_NAME="${{ inputs.service-name }}-latest"
          PORT_MAPPING="${{ inputs.container-port }}:${{ inputs.host-port }}"
          COMMON_ENV_FILE="/home/$EC2_USER/.env.common"
          SERVICE_ENV_FILE="/home/$EC2_USER/.env.${SERVICE_NAME}"
          MERGED_ENV_FILE="/tmp/.env.merged"

          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=25 -o ServerAliveCountMax=4 -i ~/.ssh/id_rsa "$EC2_USER@$HOST" << EOF
            set -e

            IMAGE="$IMAGE"
            SERVICE_NAME="$SERVICE_NAME"
            CONTAINER_NAME="$CONTAINER_NAME"
            PORT_MAPPING="$PORT_MAPPING"
            AWS_REGION="${{ secrets.AWS_REGION }}"
            AWS_ACCOUNT_ID="${{ secrets.AWS_ACCOUNT_ID }}"

            echo "=== STEP 1: Validate environment files ==="
            for f in "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE"; do


              if [ ! -f "\$f" ]; then
                echo "ERROR: Missing environment file \$f on EC2 host."
                exit 1
              fi
            done

            echo "=== STEP 2: Log environment file contents ==="
            echo "--- Common env ---"
            cat "$COMMON_ENV_FILE"
            echo "--- Service-specific env ---"
            cat "$SERVICE_ENV_FILE"

            echo "=== STEP 3: Export variables manually (line-by-line) ==="
            # 1. Read .env, ignore comments/empty lines, export variables
            set -a  # Automatically export variables
            cat "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE" | while IFS='=' read -r key value; do
                [[ -z "$key" || "$key" =~ ^# ]] && continue
                key=$(echo "$key" | xargs)
                value=$(echo "$value" | xargs)
                eval "$key=\"$value\""
            done
            set +a
            
            echo "Environment variables exported."

            echo "=== STEP 4: Substitute variables into merged env ==="
            # envsubst now works because all variables are exported
            cat "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE" | envsubst > "$MERGED_ENV_FILE"

            echo "--- Merged env output ---"
            cat "$MERGED_ENV_FILE"

            echo "=== STEP 5: Log into ECR ==="
            aws ecr get-login-password --region "\$AWS_REGION" \
              | docker login --username AWS --password-stdin \
              "\$AWS_ACCOUNT_ID.dkr.ecr.\$AWS_REGION.amazonaws.com"

            echo "=== STEP 6: Remove old images for this service ==="
            repo_prefix="\$AWS_ACCOUNT_ID.dkr.ecr.\$AWS_REGION.amazonaws.com/\$SERVICE_NAME"
            old_images=\$(docker images "\$repo_prefix" --format '{{.Repository}}:{{.Tag}}')
            if [ -n "\$old_images" ]; then
              echo "Old images:"
              echo "\$old_images"
              docker rmi -f \$old_images || true
            else
              echo "No old images found."
            fi

            echo "=== STEP 7: Optional system prune ==="
            docker system prune -a -f --volumes

            echo "=== STEP 8: Stop old container ==="
            if docker ps -a --format '{{.Names}}' | grep -q "\$CONTAINER_NAME"; then
              docker stop "\$CONTAINER_NAME" || true
              docker rm "\$CONTAINER_NAME" || true
            fi

            echo "=== STEP 9: Pull latest image ==="
            docker pull "\$IMAGE"

            echo "=== STEP 10: Run new container ==="
            docker run -d \
              --name "\$CONTAINER_NAME" \
              -p "\$PORT_MAPPING" \
              --env-file "$MERGED_ENV_FILE" \
              --restart always \
              "\$IMAGE"

            echo "=== STEP 11: Verify container ==="
            sleep 2
            docker ps | grep "\$CONTAINER_NAME"

            echo "=== SUCCESS: Deployment complete ==="
          EOF

      - name: Ensure SSH closed
        run: echo "SSH completed successfully."

