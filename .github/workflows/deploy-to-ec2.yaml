name: Deploy to EC2 (Docker Compose)

on:
  workflow_call:
    inputs:
      docker-tag:
        type: string
        required: true
      service-name:
        type: string
        required: true
      working-directory:
        type: string
        required: true
      environment:
        type: string
        required: true
      host-port:
        type: string
        required: true
      container-port:
        type: string
        required: true
    secrets:
      AWS_REGION:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AWS_EC2_HOST:
        required: true
      AWS_EC2_USER:
        required: false
      AWS_EC2_KEY_B64:
        required: true
      APP_ENV_CONTENT:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_EC2_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.AWS_EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Test connectivity
        run: nc -zv "${{ secrets.AWS_EC2_HOST }}" 22 || (echo "SSH port unreachable" && exit 1)

      - name: Deploy on EC2
        env:
          IMAGE: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ inputs['service-name'] }}:${{ inputs['docker-tag'] }}
        run: |
          EC2_USER="${{ secrets.AWS_EC2_USER || 'ec2-user' }}"
          HOST="${{ secrets.AWS_EC2_HOST }}"
          SERVICE_NAME="${{ inputs.service-name }}"

          COMMON_ENV_FILE="/home/$EC2_USER/.env.common"
          SERVICE_ENV_FILE="/home/$EC2_USER/.env.${SERVICE_NAME}"
          MERGED_ENV_FILE="/home/$EC2_USER/.env.merged.${SERVICE_NAME}"

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa "$EC2_USER@$HOST" << EOF
            set -e

            IMAGE="$IMAGE"
            SERVICE_NAME="$SERVICE_NAME"

            COMPOSE_FILE="/home/$EC2_USER/docker-compose.yml"

            echo "=== STEP 1: Validate required files ==="
            for f in "\$COMPOSE_FILE" "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE"; do
              if [ ! -f "\$f" ]; then
                echo "MISSING FILE: \$f"
                exit 1
              fi
            done
            
            echo "=== STEP 3: Create merged env file ==="
            cat "$COMMON_ENV_FILE" "$SERVICE_ENV_FILE" | envsubst > "$MERGED_ENV_FILE"

            echo "=== STEP 4: Login to ECR ==="
            aws ecr get-login-password --region "${{ secrets.AWS_REGION }}" \
              | docker login --username AWS --password-stdin \
                "${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"

            echo "=== STEP 5: Pull latest image for service ==="
            docker pull "\$IMAGE"

            echo "=== STEP 6: Deploy with Docker Compose ==="
            docker compose -f "\$COMPOSE_FILE" --env-file "\$MERGED_ENV_FILE" up -d --force-recreate "\$SERVICE_NAME"

            echo "=== STEP 7: Status ==="
            docker compose -f "\$COMPOSE_FILE" ps

            echo "=== SUCCESS ==="
          EOF

      - name: Ensure SSH closed
        run: echo "SSH session completed."
